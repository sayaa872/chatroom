<!DOCTYPE html>
<html>
<head>
    <title>Chat Room</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/friends.css">
    <link rel="stylesheet" href="/css/private-messages.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- User Profile -->
        <div class="user-profile">
            <div class="user-avatar" id="userInitials">JD</div>
            <div class="user-info">
                <h3 id="userName">Chargement...</h3>
                <span class="status">En ligne</span>
            </div>
        </div>

        <!-- Navigation -->
        <div class="nav-items">
            <button class="nav-item active" id="chatBtn">
                <i class="fas fa-comments"></i>
                Chat général
            </button>
            <button class="nav-item" id="friendsBtn">
                <i class="fas fa-user-friends"></i>
                Amis
            </button>
            <button class="nav-item" id="privateBtn">
                <i class="fas fa-envelope"></i>
                Messages privés
            </button>
        </div>

        <!-- Friends List -->
        <div class="friends-list-section">
            <h4>Amis en ligne</h4>
            <div id="onlineFriends"></div>
        </div>

        <!-- Main Content -->
        <div id="chatView" class="view">
            <div id="messages"></div>
        </div>

        <div id="friendsView" class="view hidden">
            <div class="friends-header">
                <h2>Mes amis</h2>
                <button class="add-friend-btn" id="addFriendBtn">
                    <i class="fas fa-user-plus"></i>
                    Ajouter un ami
                </button>
            </div>
            <div id="friendsList"></div>
        </div>

        <div id="privateView" class="view hidden">
            <h2>Messages privés</h2>
            <div id="conversationsList"></div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal" id="addFriendModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Ajouter un ami</h3>
                <button class="close-modal" id="closeModalBtn">&times;</button>
            </div>
            <form id="addFriendForm">
                <div class="form-group">
                    <label for="friendUsername">Nom d'utilisateur</label>
                    <input type="text" id="friendUsername" required>
                </div>
                <button type="submit">Envoyer la demande</button>
            </form>
        </div>
    </div>

    <script>
        // Vérification de l'authentification
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/login.html';
        }

        // Définition des variables globales
        let currentUser = null;
        const socket = io({
            auth: {
                token: token
            }
        });

        // Récupération des éléments DOM
        const chatBtn = document.getElementById('chatBtn');
        const friendsBtn = document.getElementById('friendsBtn');
        const privateBtn = document.getElementById('privateBtn');
        const chatView = document.getElementById('chatView');
        const friendsView = document.getElementById('friendsView');
        const privateView = document.getElementById('privateView');
        const addFriendBtn = document.getElementById('addFriendBtn');
        const addFriendModal = document.getElementById('addFriendModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const addFriendForm = document.getElementById('addFriendForm');

        // Fonctions de navigation
        chatBtn.addEventListener('click', () => {
            chatView.classList.remove('hidden');
            friendsView.classList.add('hidden');
            privateView.classList.add('hidden');
            
            chatBtn.classList.add('active');
            friendsBtn.classList.remove('active');
            privateBtn.classList.remove('active');
        });

        friendsBtn.addEventListener('click', () => {
            chatView.classList.add('hidden');
            friendsView.classList.remove('hidden');
            privateView.classList.add('hidden');
            
            chatBtn.classList.remove('active');
            friendsBtn.classList.add('active');
            privateBtn.classList.remove('active');
            
            loadFriends();
        });

        privateBtn.addEventListener('click', () => {
            chatView.classList.add('hidden');
            friendsView.classList.add('hidden');
            privateView.classList.remove('hidden');
            
            chatBtn.classList.remove('active');
            friendsBtn.classList.remove('active');
            privateBtn.classList.add('active');
            
            loadConversations();
        });

        // Gestion de la modal d'ajout d'ami
        addFriendBtn.addEventListener('click', () => {
            addFriendModal.style.display = 'flex';
        });

        closeModalBtn.addEventListener('click', () => {
            addFriendModal.style.display = 'none';
        });

        // Chargement du profil utilisateur
        async function loadUserProfile() {
            try {
                const response = await fetch('/api/auth/me', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await response.json();
                
                if (data.user) {
                    currentUser = data.user;
                    document.getElementById('userName').textContent = data.user.username;
                    
                    // Set initials
                    if (data.user.username) {
                        const initials = data.user.username.charAt(0).toUpperCase();
                        document.getElementById('userInitials').textContent = initials;
                    }
                }
            } catch (error) {
                console.error('Erreur chargement profil:', error);
            }
        }

        // Chargement des amis
        async function loadFriends() {
            try {
                const response = await fetch('/api/friends', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const friends = await response.json();
                displayFriends(friends);
            } catch (error) {
                console.error('Erreur chargement amis:', error);
            }
        }

        // Affichage des amis
        function displayFriends(friends) {
            const friendsList = document.getElementById('friendsList');
            if (!friendsList) return;
            
            if (friends.length === 0) {
                friendsList.innerHTML = '<p>Vous n\'avez pas encore d\'amis.</p>';
                return;
            }
            
            friendsList.innerHTML = friends.map(friend => `
                <div class="friend-card">
                    <div>${friend.username}</div>
                    <button class="message-btn" onclick="startConversation('${friend.id}')">
                        <i class="fas fa-comment"></i> Message
                    </button>
                </div>
            `).join('');
        }

        // Chargement des conversations
        async function loadConversations() {
            try {
                const response = await fetch('/api/conversations', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const conversations = await response.json();
                displayConversations(conversations);
            } catch (error) {
                console.error('Erreur chargement conversations:', error);
            }
        }

        // Affichage des conversations
        function displayConversations(conversations) {
            const conversationsList = document.getElementById('conversationsList');
            if (!conversationsList) return;
            
            if (conversations.length === 0) {
                conversationsList.innerHTML = '<p>Vous n\'avez pas encore de conversations.</p>';
                return;
            }
            
            conversationsList.innerHTML = conversations.map(conv => `
                <div class="conversation-item" onclick="openConversation('${conv.id}')">
                    <div class="conversation-info">
                        <h4>${conv.participants.filter(p => p !== currentUser?.username).join(', ')}</h4>
                    </div>
                </div>
            `).join('');
        }

        // Démarrer une conversation
        window.startConversation = async function(friendId) {
            try {
                const response = await fetch('/api/conversations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ participantIds: [friendId] })
                });
                
                if (response.ok) {
                    // Changer de vue
                    chatView.classList.add('hidden');
                    friendsView.classList.add('hidden');
                    privateView.classList.remove('hidden');
                    
                    chatBtn.classList.remove('active');
                    friendsBtn.classList.remove('active');
                    privateBtn.classList.add('active');
                    
                    // Recharger les conversations
                    loadConversations();
                }
            } catch (error) {
                console.error('Erreur création conversation:', error);
            }
        };

        // Envoi d'une demande d'ami
        addFriendForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('friendUsername').value;
            
            try {
                const response = await fetch('/api/friends/request', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ friendUsername: username })
                });
                
                const data = await response.json();
                if (response.ok) {
                    alert('Demande d\'ami envoyée !');
                    addFriendModal.style.display = 'none';
                    document.getElementById('friendUsername').value = '';
                } else {
                    alert(data.error || 'Erreur lors de l\'envoi de la demande');
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors de l\'envoi de la demande');
            }
        });

        // Initialisation
        loadUserProfile();
    </script>
</body>
</html> 